package com.kinect.messaging.template.controller

import com.azure.spring.data.cosmos.core.query.CosmosPageRequest
import com.fasterxml.jackson.databind.JsonNode
import com.fasterxml.jackson.module.kotlin.jacksonObjectMapper
import com.kinect.messaging.libs.model.KTemplate
import com.kinect.messaging.libs.model.TemplateLanguage
import com.kinect.messaging.libs.model.TemplatePersonalizationRequest
import com.kinect.messaging.libs.model.TemplateType
import com.kinect.messaging.template.model.TemplateEntity
import com.kinect.messaging.template.repository.TemplateRepository
import com.kinect.messaging.template.service.TemplateService
import org.junit.jupiter.api.Test
import org.mockito.BDDMockito
import org.mockito.BDDMockito.anyString
import org.mockito.BDDMockito.given
import org.springframework.beans.factory.annotation.Autowired
import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc
import org.springframework.boot.test.context.SpringBootTest
import org.springframework.boot.test.mock.mockito.MockBean
import org.springframework.context.annotation.Import
import org.springframework.data.domain.PageImpl
import org.springframework.http.MediaType
import org.springframework.test.web.reactive.server.WebTestClient
import java.util.*

@SpringBootTest
@AutoConfigureMockMvc
@Import(TemplateService::class)
class TemplateControllerTest {

    private final val baseUrl = "/kinect/messaging/template"

    @Autowired
    lateinit var webTestClient: WebTestClient

    @MockBean
    lateinit var templateRepository: TemplateRepository

    @Test
    fun createTemplate() {

        val givenInput = KTemplate(
            templateId = "1",
            templateName = "Test Get By Id",
            templateType = TemplateType.CONTROL,
            templateLanguage = TemplateLanguage.EN,
            templateContent = "Follow up on customer onboarded"
        )
        val mockData = TemplateEntity(
            templateId = "1",
            templateName = "Test Get By Id",
            templateType = TemplateType.CONTROL,
            templateLanguage = TemplateLanguage.EN,
            templateContent = "Follow up on customer onboarded"
        )
        given(templateRepository.save(mockData)).willReturn(mockData)

        webTestClient.post()
            .uri(baseUrl)
            .bodyValue(givenInput)
            .header("Content-Type", MediaType.APPLICATION_JSON_VALUE)
            .exchange()
            .expectStatus().isOk
            .expectBody(KTemplate::class.java)
    }

    @Test
    fun getTemplate() {
        val givenInput = "1"
        val expectedResult = TemplateEntity(
            templateId = "1",
            templateName = "Test Get By Id",
            templateType = TemplateType.CONTROL,
            templateLanguage = TemplateLanguage.EN,
            templateContent = "Follow up on customer onboarded"
        )
        given(templateRepository.findById(givenInput)).willReturn(Optional.of(expectedResult))

        webTestClient.get()
            .uri("$baseUrl/$givenInput")
            .exchange()
            .expectStatus().isOk
            .expectHeader().contentType(MediaType.APPLICATION_JSON)
            .expectBody(KTemplate::class.java)
    }

    @Test
    fun getAllTemplates() {
        // given
        val pageNo = 1
        val pageSize = 1
        val sortBy = "journeyId"
        val pagingOptions = CosmosPageRequest(pageNo, pageSize, sortBy)

        // mock the database response
        val expectedResult = PageImpl(
            mutableListOf(
                TemplateEntity(
                    templateId = "1",
                    templateName = "Test Get By Id 1",
                    templateType = TemplateType.CONTROL,
                    templateLanguage = TemplateLanguage.EN,
                    templateContent = "Follow up on customer onboarded"
                ),
                TemplateEntity(
                    templateId = "2",
                    templateName = "Test Get By Id 2",
                    templateType = TemplateType.CONTROL,
                    templateLanguage = TemplateLanguage.EN,
                    templateContent = "Follow up on customer onboarded"
                )
            )
        )
        given(templateRepository.findAll(BDDMockito.any(CosmosPageRequest::class.java))).willReturn(expectedResult)
        webTestClient.get()
            .uri(baseUrl)
            .exchange()
            .expectStatus().isOk
            .expectHeader().contentType(MediaType.APPLICATION_JSON)
            .expectBodyList(KTemplate::class.java).hasSize(2)
    }

    @Test
    fun `given personalization Request with no data then get HTML Template`(){

        val givenInput = TemplatePersonalizationRequest(
            "1",
            "2",
            null
        )
        val mockData = mutableListOf(
            TemplateEntity(
                templateId = "1",
                templateName = "Cruises",
                templateType = TemplateType.CONTROL,
                templateLanguage = TemplateLanguage.EN,
                templateContent = "SGksCiAgICBXZSBob3BlIHRoaXMgZW1haWwgZmluZCB5b3Ugd2VsbC4K"
            ),
            TemplateEntity(
                templateId = "2",
                templateName = "Cruises",
                templateType = TemplateType.CONTROL,
                templateLanguage = TemplateLanguage.EN,
                templateContent = "PG1qbWw+CiAgPG1qLWJvZHk+CiAgICA8IS0tIENvbXBhbnkgSGVhZGVyIC0tPgogICAgPG1qLXNlY3Rpb24gYmFja2dyb3VuZC1jb2xvcj0iI2YwZjBmMCI+CiAgICAgICAgPG1qLWNvbHVtbj4KICAgICAgICAgICAgPG1qLXRleHQgIGZvbnQtc3R5bGU9ImJvbGQiCiAgICAgICAgICAgICAgICBmb250LXNpemU9IjIwcHgiCiAgICAgICAgICAgICAgICBhbGlnbj0iY2VudGVyIgogICAgICAgICAgICAgICAgY29sb3I9IiM2MjYyNjIiPgogICAgICAgICAgICBDZW50cmFsIFBhcmsgQ3J1aXNlcwogICAgICAgICAgICA8L21qLXRleHQ+CiAgICAgICAgPC9tai1jb2x1bW4+CiAgICA8L21qLXNlY3Rpb24+CiAgICA8IS0tIEltYWdlIEhlYWRlciAtLT4KICAgIDxtai1zZWN0aW9uIGJhY2tncm91bmQtdXJsPSJodHRwczovL2NhLXRpbWVzLmJyaWdodHNwb3RjZG4uY29tL2RpbXM0L2RlZmF1bHQvMmFmMTY1Yy8yMTQ3NDgzNjQ3L3N0cmlwL3RydWUvY3JvcC8yMDQ4eDEzNjMrMCswL3Jlc2l6ZS8xNDQweDk1OCEvcXVhbGl0eS85MC8/dXJsPWh0dHBzJTNBJTJGJTJGd3d3LnRyYmltZy5jb20lMkZpbWctNGY1NjFkMzclMkZ0dXJiaW5lJTJGb3JsLWRpc25leWZhbnRhc3k3MjAxMjAzMDYwNjIwNTUiCiAgICAgICAgYmFja2dyb3VuZC1zaXplPSJjb3ZlciIKICAgICAgICBiYWNrZ3JvdW5kLXJlcGVhdD0ibm8tcmVwZWF0Ij4KICAgICAgICA8bWotY29sdW1uIHdpZHRoPSI2MDBweCI+CiAgICAgICAgICAgIDxtai10ZXh0ICBhbGlnbj0iY2VudGVyIgogICAgICAgICAgICAgICAgY29sb3I9IiNmZmYiCiAgICAgICAgICAgICAgICBmb250LXNpemU9IjQwcHgiCiAgICAgICAgICAgICAgICBmb250LWZhbWlseT0iSGVsdmV0aWNhIE5ldWUiPkNocmlzdG1hcyBEaXNjb3VudDwvbWotdGV4dD4KICAgICAgICAgICAgPG1qLWJ1dHRvbiBiYWNrZ3JvdW5kLWNvbG9yPSIjRjYzQTREIiBocmVmPSIjIj4KICAgICAgICAgICAgICAgIFNlZSBQcm9tb3Rpb25zCiAgICAgICAgICAgIDwvbWotYnV0dG9uPgogICAgICAgIDwvbWotY29sdW1uPgogICAgPC9tai1zZWN0aW9uPgogICAgPCEtLSBFbWFpbCBJbnRyb2R1Y3Rpb24gLS0+CiAgICA8bWotc2VjdGlvbiBiYWNrZ3JvdW5kLWNvbG9yPSIjZmFmYWZhIj4KICAgICAgICA8bWotY29sdW1uIHdpZHRoPSI0MDBweCI+CiAgICAgICAgICA8bWotdGV4dCBmb250LXN0eWxlPSJib2xkIgogICAgICAgICAgICBmb250LXNpemU9IjIwcHgiCiAgICAgICAgICAgIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EgTmV1ZSIKICAgICAgICAgICAgY29sb3I9IiM2MjYyNjIiPlVsdGltYXRlIENocmlzdG1hcyBFeHBlcmllbmNlPC9tai10ZXh0PgogICAgICAgICAgICA8bWotdGV4dCBjb2xvcj0iIzUyNTI1MiI+CiAgICAgICAgICAgICAgICBMb3JlbSBpcHN1bSBkb2xvciBzaXQgYW1ldCwgY29uc2VjdGV0dXIgYWRpcGlzY2luZyBlbGl0LiBQcm9pbiBydXRydW0gZW5pbSBlZ2V0IG1hZ25hIGVmZmljaXR1ciwgZXUgc2VtcGVyIGF1Z3VlIHNlbXBlci4gQWxpcXVhbSBlcmF0IHZvbHV0cGF0LiBDcmFzIGlkIGR1aSBsZWN0dXMuIFZlc3RpYnVsdW0gc2VkIGZpbmlidXMgbGVjdHVzLCBzaXQgYW1ldCBzdXNjaXBpdCBuaWJoLiBQcm9pbiBuZWMgY29tbW9kbyBwdXJ1cy4gU2VkIGVnZXQgbnVsbGEgZWxpdC4gTnVsbGEgYWxpcXVldCBtb2xsaXMgZmF1Y2lidXMuCiAgICAgICAgICAgIDwvbWotdGV4dD4KICAgICAgICAgICAgPG1qLWJ1dHRvbiBiYWNrZ3JvdW5kLWNvbG9yPSIjRjQ1RTQzIiBocmVmPSIjIj5MZWFybiBtb3JlPC9tai1idXR0b24+CiAgICAgICAgPC9tai1jb2x1bW4+CiAgICA8L21qLXNlY3Rpb24+CiAgICA8IS0tIENvbHVtbnMgc2VjdGlvbiAtLT4KICAgIDxtai1zZWN0aW9uIGJhY2tncm91bmQtY29sb3I9IndoaXRlIj4KICAgICAgICA8IS0tIExlZnQgaW1hZ2UgLS0+CiAgICAgICAgPG1qLWNvbHVtbj4KICAgICAgICAgICAgPG1qLWltYWdlIHdpZHRoPSIyMDBweCIKICAgICAgICAgICAgICAgIHNyYz0iaHR0cHM6Ly9uYXZpcy1jb25zdWx0aW5nLmNvbS93cC1jb250ZW50L3VwbG9hZHMvMjAxOS8wOS9DcnVpc2UxLTEucG5nIi8+CiAgICAgICAgPC9tai1jb2x1bW4+CiAgICAgICAgPCEtLSByaWdodCBwYXJhZ3JhcGggLS0+CiAgICAgICAgPG1qLWNvbHVtbj4KICAgICAgICAgICAgPG1qLXRleHQgZm9udC1zdHlsZT0iYm9sZCIKICAgICAgICAgICAgICAgIGZvbnQtc2l6ZT0iMjBweCIKICAgICAgICAgICAgICAgIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EgTmV1ZSIKICAgICAgICAgICAgICAgIGNvbG9yPSIjNjI2MjYyIj4KICAgICAgICAgICAgICAgIEFtYXppbmcgRXhwZXJpZW5jZXMKICAgICAgICAgICAgPC9tai10ZXh0PgogICAgICAgICAgICA8bWotdGV4dCBjb2xvcj0iIzUyNTI1MiI+CiAgICAgICAgICAgICAgICBMb3JlbSBpcHN1bSBkb2xvciBzaXQgYW1ldCwgY29uc2VjdGV0dXIgYWRpcGlzY2luZyBlbGl0LiAKICAgICAgICAgICAgICAgIFByb2luIHJ1dHJ1bSBlbmltIGVnZXQgbWFnbmEgZWZmaWNpdHVyLCBldSBzZW1wZXIgYXVndWUgc2VtcGVyLiAKICAgICAgICAgICAgICAgIEFsaXF1YW0gZXJhdCB2b2x1dHBhdC4gQ3JhcyBpZCBkdWkgbGVjdHVzLiBWZXN0aWJ1bHVtIHNlZCBmaW5pYnVzIAogICAgICAgICAgICAgICAgbGVjdHVzLgogICAgICAgICAgICA8L21qLXRleHQ+CiAgICAgICAgPC9tai1jb2x1bW4+CiAgICA8L21qLXNlY3Rpb24+CiAgICA8IS0tIEljb25zIC0tPgogICAgPG1qLXNlY3Rpb24gYmFja2dyb3VuZC1jb2xvcj0iI2ZiZmJmYiI+CiAgICAgICAgPG1qLWNvbHVtbj4KICAgICAgICAgICAgPG1qLWltYWdlIHdpZHRoPSIxMDBweCIgc3JjPSJodHRwczovLzE5MW4ubWouYW0vaW1nLzE5MW4vM3MveDBsLnBuZyIgLz4KICAgICAgICA8L21qLWNvbHVtbj4KICAgICAgICA8bWotY29sdW1uPgogICAgICAgICAgICA8bWotaW1hZ2Ugd2lkdGg9IjEwMHB4IiBzcmM9Imh0dHBzOi8vMTkxbi5tai5hbS9pbWcvMTkxbi8zcy94MDEucG5nIiAvPgogICAgICAgIDwvbWotY29sdW1uPgogICAgICAgIDxtai1jb2x1bW4+CiAgICAgICAgICAgIDxtai1pbWFnZSB3aWR0aD0iMTAwcHgiIHNyYz0iaHR0cHM6Ly8xOTFuLm1qLmFtL2ltZy8xOTFuLzNzL3gwcy5wbmciIC8+CiAgICAgICAgPC9tai1jb2x1bW4+CiAgICA8L21qLXNlY3Rpb24+CiAgICA8IS0tIFNvY2lhbCBpY29ucyAtLT4KICAgIDxtai1zZWN0aW9uIGJhY2tncm91bmQtY29sb3I9IiNlN2U3ZTciPgogICAgICAgIDxtai1jb2x1bW4+CiAgICAgICAgICAgIDxtai1zb2NpYWw+CiAgICAgICAgICAgICAgICA8bWotc29jaWFsLWVsZW1lbnQgbmFtZT0iaW5zdGFncmFtIiAvPgogICAgICAgICAgICA8L21qLXNvY2lhbD4KICAgICAgICA8L21qLWNvbHVtbj4KICAgIDwvbWotc2VjdGlvbj4KICA8L21qLWJvZHk+CjwvbWptbD4="
            )
        )
        val expectedResult = mutableListOf(
            KTemplate(
                templateId = "1",
                templateName = "Cruises",
                templateType = TemplateType.CONTROL,
                templateLanguage = TemplateLanguage.EN,
                templateContent = "Hi,\n" +
                        "    We hope this email find you well.\n"
            ),
            KTemplate(
                templateId = "2",
                templateName = "Cruises",
                templateType = TemplateType.CONTROL,
                templateLanguage = TemplateLanguage.EN,
                templateContent = "\n    <!doctype html>\n    <html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:v=\"urn:schemas-microsoft-com:vml\" xmlns:o=\"urn:schemas-microsoft-com:office:office\">\n      <head>\n        <title>\n          \n        </title>\n        <!--[if !mso]><!-- -->\n        <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\">\n        <!--<![endif]-->\n        <meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\">\n        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n        <style type=\"text/css\">\n          #outlook a { padding:0; }\n          body { margin:0;padding:0;-webkit-text-size-adjust:100%;-ms-text-size-adjust:100%; }\n          table, td { border-collapse:collapse;mso-table-lspace:0pt;mso-table-rspace:0pt; }\n          img { border:0;height:auto;line-height:100%; outline:none;text-decoration:none;-ms-interpolation-mode:bicubic; }\n          p { display:block;margin:13px 0; }\n        </style>\n        <!--[if mso]>\n        <xml>\n        <o:OfficeDocumentSettings>\n          <o:AllowPNG/>\n          <o:PixelsPerInch>96</o:PixelsPerInch>\n        </o:OfficeDocumentSettings>\n        </xml>\n        <![endif]-->\n        <!--[if lte mso 11]>\n        <style type=\"text/css\">\n          .mj-outlook-group-fix { width:100% !important; }\n        </style>\n        <![endif]-->\n        \n      <!--[if !mso]><!-->\n        <link href=\"https://fonts.googleapis.com/css?family=Ubuntu:300,400,500,700\" rel=\"stylesheet\" type=\"text/css\">\n        <style type=\"text/css\">\n          @import url(https://fonts.googleapis.com/css?family=Ubuntu:300,400,500,700);\n        </style>\n      <!--<![endif]-->\n\n    \n        \n    <style type=\"text/css\">\n      @media only screen and (min-width:480px) {\n        .mj-column-per-100 { width:100% !important; max-width: 100%; }\n.mj-column-px-600 { width:600px !important; max-width: 600px; }\n.mj-column-px-400 { width:400px !important; max-width: 400px; }\n.mj-column-per-50 { width:50% !important; max-width: 50%; }\n.mj-column-per-33-333333333333336 { width:33.333333333333336% !important; max-width: 33.333333333333336%; }\n      }\n    </style>\n    \n  \n        <style type=\"text/css\">\n        \n        \n\n    @media only screen and (max-width:480px) {\n      table.mj-full-width-mobile { width: 100% !important; }\n      td.mj-full-width-mobile { width: auto !important; }\n    }\n  \n        </style>\n        \n        \n      </head>\n      <body>\n        \n        \n      <div\n         style=\"\"\n      >\n        <!-- Company Header -->\n      \n      <!--[if mso | IE]>\n      <table\n         align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" class=\"\" style=\"width:600px;\" width=\"600\"\n      >\n        <tr>\n          <td style=\"line-height:0px;font-size:0px;mso-line-height-rule:exactly;\">\n      <![endif]-->\n    \n      \n      <div  style=\"background:#f0f0f0;background-color:#f0f0f0;margin:0px auto;max-width:600px;\">\n        \n        <table\n           align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"background:#f0f0f0;background-color:#f0f0f0;width:100%;\"\n        >\n          <tbody>\n            <tr>\n              <td\n                 style=\"direction:ltr;font-size:0px;padding:20px 0;text-align:center;\"\n              >\n                <!--[if mso | IE]>\n                  <table role=\"presentation\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n                \n        <tr>\n      \n            <td\n               class=\"\" style=\"vertical-align:top;width:600px;\"\n            >\n          <![endif]-->\n            \n      <div\n         class=\"mj-column-per-100 mj-outlook-group-fix\" style=\"font-size:0px;text-align:left;direction:ltr;display:inline-block;vertical-align:top;width:100%;\"\n      >\n        \n      <table\n         border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"vertical-align:top;\" width=\"100%\"\n      >\n        \n            <tr>\n              <td\n                 align=\"center\" style=\"font-size:0px;padding:10px 25px;word-break:break-word;\"\n              >\n                \n      <div\n         style=\"font-family:Ubuntu, Helvetica, Arial, sans-serif;font-size:20px;font-style:bold;line-height:1;text-align:center;color:#626262;\"\n      >Central Park Cruises</div>\n    \n              </td>\n            </tr>\n          \n      </table>\n    \n      </div>\n    \n          <!--[if mso | IE]>\n            </td>\n          \n        </tr>\n      \n                  </table>\n                <![endif]-->\n              </td>\n            </tr>\n          </tbody>\n        </table>\n        \n      </div>\n    \n      \n      <!--[if mso | IE]>\n          </td>\n        </tr>\n      </table>\n      <![endif]-->\n    \n    <!-- Image Header -->\n      \n      <!--[if mso | IE]>\n      <table\n         align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" class=\"\" style=\"width:600px;\" width=\"600\"\n      >\n        <tr>\n          <td style=\"line-height:0px;font-size:0px;mso-line-height-rule:exactly;\">\n      \n        <v:rect  style=\"width:600px;\" xmlns:v=\"urn:schemas-microsoft-com:vml\" fill=\"true\" stroke=\"false\">\n        <v:fill  origin=\"0.5, 0\" position=\"0.5, 0\" src=\"https://ca-times.brightspotcdn.com/dims4/default/2af165c/2147483647/strip/true/crop/2048x1363+0+0/resize/1440x958!/quality/90/?url=https%3A%2F%2Fwww.trbimg.com%2Fimg-4f561d37%2Fturbine%2Forl-disneyfantasy720120306062055\" type=\"tile\" />\n        <v:textbox style=\"mso-fit-shape-to-text:true\" inset=\"0,0,0,0\">\n      <![endif]-->\n          \n      <div  style=\"background:url(https://ca-times.brightspotcdn.com/dims4/default/2af165c/2147483647/strip/true/crop/2048x1363+0+0/resize/1440x958!/quality/90/?url=https%3A%2F%2Fwww.trbimg.com%2Fimg-4f561d37%2Fturbine%2Forl-disneyfantasy720120306062055) top center / cover no-repeat;margin:0px auto;max-width:600px;\">\n        <div  style=\"line-height:0;font-size:0;\">\n        <table\n           align=\"center\" background=\"https://ca-times.brightspotcdn.com/dims4/default/2af165c/2147483647/strip/true/crop/2048x1363+0+0/resize/1440x958!/quality/90/?url=https%3A%2F%2Fwww.trbimg.com%2Fimg-4f561d37%2Fturbine%2Forl-disneyfantasy720120306062055\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"background:url(https://ca-times.brightspotcdn.com/dims4/default/2af165c/2147483647/strip/true/crop/2048x1363+0+0/resize/1440x958!/quality/90/?url=https%3A%2F%2Fwww.trbimg.com%2Fimg-4f561d37%2Fturbine%2Forl-disneyfantasy720120306062055) top center / cover no-repeat;width:100%;\"\n        >\n          <tbody>\n            <tr>\n              <td\n                 style=\"direction:ltr;font-size:0px;padding:20px 0;text-align:center;\"\n              >\n                <!--[if mso | IE]>\n                  <table role=\"presentation\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n                \n        <tr>\n      \n            <td\n               class=\"\" style=\"vertical-align:top;width:600px;\"\n            >\n          <![endif]-->\n            \n      <div\n         class=\"mj-column-px-600 mj-outlook-group-fix\" style=\"font-size:0px;text-align:left;direction:ltr;display:inline-block;vertical-align:top;width:100%;\"\n      >\n        \n      <table\n         border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"vertical-align:top;\" width=\"100%\"\n      >\n        \n            <tr>\n              <td\n                 align=\"center\" style=\"font-size:0px;padding:10px 25px;word-break:break-word;\"\n              >\n                \n      <div\n         style=\"font-family:Helvetica Neue;font-size:40px;line-height:1;text-align:center;color:#ffffff;\"\n      >Christmas Discount</div>\n    \n              </td>\n            </tr>\n          \n            <tr>\n              <td\n                 align=\"center\" vertical-align=\"middle\" style=\"font-size:0px;padding:10px 25px;word-break:break-word;\"\n              >\n                \n      <table\n         border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"border-collapse:separate;line-height:100%;\"\n      >\n        <tr>\n          <td\n             align=\"center\" bgcolor=\"#F63A4D\" role=\"presentation\" style=\"border:none;border-radius:3px;cursor:auto;mso-padding-alt:10px 25px;background:#F63A4D;\" valign=\"middle\"\n          >\n            <a\n               href=\"#\" style=\"display:inline-block;background:#F63A4D;color:#ffffff;font-family:Ubuntu, Helvetica, Arial, sans-serif;font-size:13px;font-weight:normal;line-height:120%;margin:0;text-decoration:none;text-transform:none;padding:10px 25px;mso-padding-alt:0px;border-radius:3px;\" target=\"_blank\"\n            >\n              See Promotions\n            </a>\n          </td>\n        </tr>\n      </table>\n    \n              </td>\n            </tr>\n          \n      </table>\n    \n      </div>\n    \n          <!--[if mso | IE]>\n            </td>\n          \n        </tr>\n      \n                  </table>\n                <![endif]-->\n              </td>\n            </tr>\n          </tbody>\n        </table>\n        </div>\n      </div>\n    \n        <!--[if mso | IE]>\n        </v:textbox>\n      </v:rect>\n    \n          </td>\n        </tr>\n      </table>\n      <![endif]-->\n    \n    <!-- Email Introduction -->\n      \n      <!--[if mso | IE]>\n      <table\n         align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" class=\"\" style=\"width:600px;\" width=\"600\"\n      >\n        <tr>\n          <td style=\"line-height:0px;font-size:0px;mso-line-height-rule:exactly;\">\n      <![endif]-->\n    \n      \n      <div  style=\"background:#fafafa;background-color:#fafafa;margin:0px auto;max-width:600px;\">\n        \n        <table\n           align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"background:#fafafa;background-color:#fafafa;width:100%;\"\n        >\n          <tbody>\n            <tr>\n              <td\n                 style=\"direction:ltr;font-size:0px;padding:20px 0;text-align:center;\"\n              >\n                <!--[if mso | IE]>\n                  <table role=\"presentation\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n                \n        <tr>\n      \n            <td\n               class=\"\" style=\"vertical-align:top;width:400px;\"\n            >\n          <![endif]-->\n            \n      <div\n         class=\"mj-column-px-400 mj-outlook-group-fix\" style=\"font-size:0px;text-align:left;direction:ltr;display:inline-block;vertical-align:top;width:100%;\"\n      >\n        \n      <table\n         border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"vertical-align:top;\" width=\"100%\"\n      >\n        \n            <tr>\n              <td\n                 align=\"left\" style=\"font-size:0px;padding:10px 25px;word-break:break-word;\"\n              >\n                \n      <div\n         style=\"font-family:Helvetica Neue;font-size:20px;font-style:bold;line-height:1;text-align:left;color:#626262;\"\n      >Ultimate Christmas Experience</div>\n    \n              </td>\n            </tr>\n          \n            <tr>\n              <td\n                 align=\"left\" style=\"font-size:0px;padding:10px 25px;word-break:break-word;\"\n              >\n                \n      <div\n         style=\"font-family:Ubuntu, Helvetica, Arial, sans-serif;font-size:13px;line-height:1;text-align:left;color:#525252;\"\n      >Lorem ipsum dolor sit amet, consectetur adipiscing elit. Proin rutrum enim eget magna efficitur, eu semper augue semper. Aliquam erat volutpat. Cras id dui lectus. Vestibulum sed finibus lectus, sit amet suscipit nibh. Proin nec commodo purus. Sed eget nulla elit. Nulla aliquet mollis faucibus.</div>\n    \n              </td>\n            </tr>\n          \n            <tr>\n              <td\n                 align=\"center\" vertical-align=\"middle\" style=\"font-size:0px;padding:10px 25px;word-break:break-word;\"\n              >\n                \n      <table\n         border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"border-collapse:separate;line-height:100%;\"\n      >\n        <tr>\n          <td\n             align=\"center\" bgcolor=\"#F45E43\" role=\"presentation\" style=\"border:none;border-radius:3px;cursor:auto;mso-padding-alt:10px 25px;background:#F45E43;\" valign=\"middle\"\n          >\n            <a\n               href=\"#\" style=\"display:inline-block;background:#F45E43;color:#ffffff;font-family:Ubuntu, Helvetica, Arial, sans-serif;font-size:13px;font-weight:normal;line-height:120%;margin:0;text-decoration:none;text-transform:none;padding:10px 25px;mso-padding-alt:0px;border-radius:3px;\" target=\"_blank\"\n            >\n              Learn more\n            </a>\n          </td>\n        </tr>\n      </table>\n    \n              </td>\n            </tr>\n          \n      </table>\n    \n      </div>\n    \n          <!--[if mso | IE]>\n            </td>\n          \n        </tr>\n      \n                  </table>\n                <![endif]-->\n              </td>\n            </tr>\n          </tbody>\n        </table>\n        \n      </div>\n    \n      \n      <!--[if mso | IE]>\n          </td>\n        </tr>\n      </table>\n      <![endif]-->\n    \n    <!-- Columns section -->\n      \n      <!--[if mso | IE]>\n      <table\n         align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" class=\"\" style=\"width:600px;\" width=\"600\"\n      >\n        <tr>\n          <td style=\"line-height:0px;font-size:0px;mso-line-height-rule:exactly;\">\n      <![endif]-->\n    \n      \n      <div  style=\"background:white;background-color:white;margin:0px auto;max-width:600px;\">\n        \n        <table\n           align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"background:white;background-color:white;width:100%;\"\n        >\n          <tbody>\n            <tr>\n              <td\n                 style=\"direction:ltr;font-size:0px;padding:20px 0;text-align:center;\"\n              >\n                <!--[if mso | IE]>\n                  <table role=\"presentation\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n                \n        <tr>\n      <![endif]-->\n      <!-- Left image -->\n          <!--[if mso | IE]>\n            <td\n               class=\"\" style=\"vertical-align:top;width:300px;\"\n            >\n          <![endif]-->\n            \n      <div\n         class=\"mj-column-per-50 mj-outlook-group-fix\" style=\"font-size:0px;text-align:left;direction:ltr;display:inline-block;vertical-align:top;width:100%;\"\n      >\n        \n      <table\n         border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"vertical-align:top;\" width=\"100%\"\n      >\n        \n            <tr>\n              <td\n                 align=\"center\" style=\"font-size:0px;padding:10px 25px;word-break:break-word;\"\n              >\n                \n      <table\n         border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"border-collapse:collapse;border-spacing:0px;\"\n      >\n        <tbody>\n          <tr>\n            <td  style=\"width:200px;\">\n              \n      <img\n         height=\"auto\" src=\"https://navis-consulting.com/wp-content/uploads/2019/09/Cruise1-1.png\" style=\"border:0;display:block;outline:none;text-decoration:none;height:auto;width:100%;font-size:13px;\" width=\"200\"\n      />\n    \n            </td>\n          </tr>\n        </tbody>\n      </table>\n    \n              </td>\n            </tr>\n          \n      </table>\n    \n      </div>\n    \n          <!--[if mso | IE]>\n            </td>\n          <![endif]-->\n    <!-- right paragraph -->\n          <!--[if mso | IE]>\n            <td\n               class=\"\" style=\"vertical-align:top;width:300px;\"\n            >\n          <![endif]-->\n            \n      <div\n         class=\"mj-column-per-50 mj-outlook-group-fix\" style=\"font-size:0px;text-align:left;direction:ltr;display:inline-block;vertical-align:top;width:100%;\"\n      >\n        \n      <table\n         border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"vertical-align:top;\" width=\"100%\"\n      >\n        \n            <tr>\n              <td\n                 align=\"left\" style=\"font-size:0px;padding:10px 25px;word-break:break-word;\"\n              >\n                \n      <div\n         style=\"font-family:Helvetica Neue;font-size:20px;font-style:bold;line-height:1;text-align:left;color:#626262;\"\n      >Amazing Experiences</div>\n    \n              </td>\n            </tr>\n          \n            <tr>\n              <td\n                 align=\"left\" style=\"font-size:0px;padding:10px 25px;word-break:break-word;\"\n              >\n                \n      <div\n         style=\"font-family:Ubuntu, Helvetica, Arial, sans-serif;font-size:13px;line-height:1;text-align:left;color:#525252;\"\n      >Lorem ipsum dolor sit amet, consectetur adipiscing elit. \n                Proin rutrum enim eget magna efficitur, eu semper augue semper. \n                Aliquam erat volutpat. Cras id dui lectus. Vestibulum sed finibus \n                lectus.</div>\n    \n              </td>\n            </tr>\n          \n      </table>\n    \n      </div>\n    \n          <!--[if mso | IE]>\n            </td>\n          \n        </tr>\n      \n                  </table>\n                <![endif]-->\n              </td>\n            </tr>\n          </tbody>\n        </table>\n        \n      </div>\n    \n      \n      <!--[if mso | IE]>\n          </td>\n        </tr>\n      </table>\n      <![endif]-->\n    \n    <!-- Icons -->\n      \n      <!--[if mso | IE]>\n      <table\n         align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" class=\"\" style=\"width:600px;\" width=\"600\"\n      >\n        <tr>\n          <td style=\"line-height:0px;font-size:0px;mso-line-height-rule:exactly;\">\n      <![endif]-->\n    \n      \n      <div  style=\"background:#fbfbfb;background-color:#fbfbfb;margin:0px auto;max-width:600px;\">\n        \n        <table\n           align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"background:#fbfbfb;background-color:#fbfbfb;width:100%;\"\n        >\n          <tbody>\n            <tr>\n              <td\n                 style=\"direction:ltr;font-size:0px;padding:20px 0;text-align:center;\"\n              >\n                <!--[if mso | IE]>\n                  <table role=\"presentation\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n                \n        <tr>\n      \n            <td\n               class=\"\" style=\"vertical-align:top;width:200px;\"\n            >\n          <![endif]-->\n            \n      <div\n         class=\"mj-column-per-33-333333333333336 mj-outlook-group-fix\" style=\"font-size:0px;text-align:left;direction:ltr;display:inline-block;vertical-align:top;width:100%;\"\n      >\n        \n      <table\n         border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"vertical-align:top;\" width=\"100%\"\n      >\n        \n            <tr>\n              <td\n                 align=\"center\" style=\"font-size:0px;padding:10px 25px;word-break:break-word;\"\n              >\n                \n      <table\n         border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"border-collapse:collapse;border-spacing:0px;\"\n      >\n        <tbody>\n          <tr>\n            <td  style=\"width:100px;\">\n              \n      <img\n         height=\"auto\" src=\"https://191n.mj.am/img/191n/3s/x0l.png\" style=\"border:0;display:block;outline:none;text-decoration:none;height:auto;width:100%;font-size:13px;\" width=\"100\"\n      />\n    \n            </td>\n          </tr>\n        </tbody>\n      </table>\n    \n              </td>\n            </tr>\n          \n      </table>\n    \n      </div>\n    \n          <!--[if mso | IE]>\n            </td>\n          \n            <td\n               class=\"\" style=\"vertical-align:top;width:200px;\"\n            >\n          <![endif]-->\n            \n      <div\n         class=\"mj-column-per-33-333333333333336 mj-outlook-group-fix\" style=\"font-size:0px;text-align:left;direction:ltr;display:inline-block;vertical-align:top;width:100%;\"\n      >\n        \n      <table\n         border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"vertical-align:top;\" width=\"100%\"\n      >\n        \n            <tr>\n              <td\n                 align=\"center\" style=\"font-size:0px;padding:10px 25px;word-break:break-word;\"\n              >\n                \n      <table\n         border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"border-collapse:collapse;border-spacing:0px;\"\n      >\n        <tbody>\n          <tr>\n            <td  style=\"width:100px;\">\n              \n      <img\n         height=\"auto\" src=\"https://191n.mj.am/img/191n/3s/x01.png\" style=\"border:0;display:block;outline:none;text-decoration:none;height:auto;width:100%;font-size:13px;\" width=\"100\"\n      />\n    \n            </td>\n          </tr>\n        </tbody>\n      </table>\n    \n              </td>\n            </tr>\n          \n      </table>\n    \n      </div>\n    \n          <!--[if mso | IE]>\n            </td>\n          \n            <td\n               class=\"\" style=\"vertical-align:top;width:200px;\"\n            >\n          <![endif]-->\n            \n      <div\n         class=\"mj-column-per-33-333333333333336 mj-outlook-group-fix\" style=\"font-size:0px;text-align:left;direction:ltr;display:inline-block;vertical-align:top;width:100%;\"\n      >\n        \n      <table\n         border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"vertical-align:top;\" width=\"100%\"\n      >\n        \n            <tr>\n              <td\n                 align=\"center\" style=\"font-size:0px;padding:10px 25px;word-break:break-word;\"\n              >\n                \n      <table\n         border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"border-collapse:collapse;border-spacing:0px;\"\n      >\n        <tbody>\n          <tr>\n            <td  style=\"width:100px;\">\n              \n      <img\n         height=\"auto\" src=\"https://191n.mj.am/img/191n/3s/x0s.png\" style=\"border:0;display:block;outline:none;text-decoration:none;height:auto;width:100%;font-size:13px;\" width=\"100\"\n      />\n    \n            </td>\n          </tr>\n        </tbody>\n      </table>\n    \n              </td>\n            </tr>\n          \n      </table>\n    \n      </div>\n    \n          <!--[if mso | IE]>\n            </td>\n          \n        </tr>\n      \n                  </table>\n                <![endif]-->\n              </td>\n            </tr>\n          </tbody>\n        </table>\n        \n      </div>\n    \n      \n      <!--[if mso | IE]>\n          </td>\n        </tr>\n      </table>\n      <![endif]-->\n    \n    <!-- Social icons -->\n      \n      <!--[if mso | IE]>\n      <table\n         align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" class=\"\" style=\"width:600px;\" width=\"600\"\n      >\n        <tr>\n          <td style=\"line-height:0px;font-size:0px;mso-line-height-rule:exactly;\">\n      <![endif]-->\n    \n      \n      <div  style=\"background:#e7e7e7;background-color:#e7e7e7;margin:0px auto;max-width:600px;\">\n        \n        <table\n           align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"background:#e7e7e7;background-color:#e7e7e7;width:100%;\"\n        >\n          <tbody>\n            <tr>\n              <td\n                 style=\"direction:ltr;font-size:0px;padding:20px 0;text-align:center;\"\n              >\n                <!--[if mso | IE]>\n                  <table role=\"presentation\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n                \n        <tr>\n      \n            <td\n               class=\"\" style=\"vertical-align:top;width:600px;\"\n            >\n          <![endif]-->\n            \n      <div\n         class=\"mj-column-per-100 mj-outlook-group-fix\" style=\"font-size:0px;text-align:left;direction:ltr;display:inline-block;vertical-align:top;width:100%;\"\n      >\n        \n      <table\n         border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"vertical-align:top;\" width=\"100%\"\n      >\n        \n            <tr>\n              <td\n                 align=\"center\" style=\"font-size:0px;padding:10px 25px;word-break:break-word;\"\n              >\n                \n      \n     <!--[if mso | IE]>\n      <table\n         align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\"\n      >\n        <tr>\n      \n              <td>\n            <![endif]-->\n              <table\n                 align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"float:none;display:inline-table;\"\n              >\n                \n      <tr\n        \n      >\n        <td  style=\"padding:4px;\">\n          <table\n             border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"background:#3f729b;border-radius:3px;width:20px;\"\n          >\n            <tr>\n              <td  style=\"font-size:0;height:20px;vertical-align:middle;width:20px;\">\n                \n                    <img\n                       height=\"20\" src=\"https://www.mailjet.com/images/theme/v1/icons/ico-social/instagram.png\" style=\"border-radius:3px;display:block;\" width=\"20\"\n                    />\n                  \n                </td>\n              </tr>\n          </table>\n        </td>\n        \n      </tr>\n    \n              </table>\n            <!--[if mso | IE]>\n              </td>\n            \n          </tr>\n        </table>\n      <![endif]-->\n    \n    \n              </td>\n            </tr>\n          \n      </table>\n    \n      </div>\n    \n          <!--[if mso | IE]>\n            </td>\n          \n        </tr>\n      \n                  </table>\n                <![endif]-->\n              </td>\n            </tr>\n          </tbody>\n        </table>\n        \n      </div>\n    \n      \n      <!--[if mso | IE]>\n          </td>\n        </tr>\n      </table>\n      <![endif]-->\n    \n    \n      </div>\n    \n      </body>\n    </html>\n  "
            )
        )

        //given
        given(templateRepository.findById(anyString()))
            .willAnswer {
                val argument = it.arguments[0]
                when(argument){
                    "1" -> Optional.of(mockData[0])
                    "2" -> Optional.of(mockData[1])
                    else -> Optional.empty()
                }

            }

        //when
        val actualResult = webTestClient.post()
            .uri("$baseUrl/personalize")
            .bodyValue(givenInput)
            .header("Content-Type", MediaType.APPLICATION_JSON_VALUE)
            .exchange()
            .expectStatus().isOk
            .expectBodyList(KTemplate::class.java)
            .returnResult()
            .responseBody

        //then
        expectedResult.forEach {expected ->
            actualResult?.first { it.templateId == expected.templateId }?.templateContent?.isNotBlank()?.let { assert(it) }
        }

    }

    @Test
    fun `given personalization Request with data then get HTML Template`(){

        val personalizationData = mutableMapOf(
            Pair("promotion", mutableMapOf(Pair("name", "New Year Promotion"))),
            Pair("users", mutableMapOf(Pair("receivingUser", "Jane"), Pair("sendingUser", "Doe")))
        )
        val jsonNode = jacksonObjectMapper().valueToTree<JsonNode>(personalizationData)
        val givenInput = TemplatePersonalizationRequest(
            "1",
            "2",
            personalizationData
        )
        val mockData = mutableListOf(
            TemplateEntity(
                templateId = "1",
                templateName = "Cruises",
                templateType = TemplateType.CONTROL,
                templateLanguage = TemplateLanguage.EN,
                templateContent = "8J+RiyB7e3VzZXJzLnJlY2VpdmluZ1VzZXJ9fSwKCjwhLS1pZiBzZW5kaW5nVXNlciBpcyBleGlzdHMgaW4gdGhlIGNvbnRleHQtLT4Ke3sjdXNlcnMuc2VuZGluZ1VzZXJ9fQogICAge3t1c2Vycy5zZW5kaW5nVXNlcn19IHdlbGNvbWVzIHlvdS4Ke3svdXNlcnMuc2VuZGluZ1VzZXJ9fQoKPCEtLWlmIHNlbmRpbmdVc2VyIGlzIGRvZXNuJ3QgZXhpc3QgaW4gdGhlIGNvbnRleHQtLT4Ke3tedXNlcnMuc2VuZGluZ1VzZXJ9fQogICAgV2UgaG9wZSB0aGlzIGVtYWlsIGZpbmQgeW91IHdlbGwuCnt7L3VzZXJzLnNlbmRpbmdVc2VyfX0="
            ),
            TemplateEntity(
                templateId = "2",
                templateName = "Cruises",
                templateType = TemplateType.CONTROL,
                templateLanguage = TemplateLanguage.EN,
                templateContent = "PG1qbWw+CiAgPG1qLWJvZHk+CiAgICA8IS0tIENvbXBhbnkgSGVhZGVyIC0tPgogICAgPG1qLXNlY3Rpb24gYmFja2dyb3VuZC1jb2xvcj0iI2YwZjBmMCI+CiAgICAgICAgPG1qLWNvbHVtbj4KICAgICAgICAgICAgPG1qLXRleHQgIGZvbnQtc3R5bGU9ImJvbGQiCiAgICAgICAgICAgICAgICBmb250LXNpemU9IjIwcHgiCiAgICAgICAgICAgICAgICBhbGlnbj0iY2VudGVyIgogICAgICAgICAgICAgICAgY29sb3I9IiM2MjYyNjIiPgogICAgICAgICAgICBDZW50cmFsIFBhcmsgQ3J1aXNlcwogICAgICAgICAgICA8L21qLXRleHQ+CiAgICAgICAgPC9tai1jb2x1bW4+CiAgICA8L21qLXNlY3Rpb24+CiAgICA8IS0tIEltYWdlIEhlYWRlciAtLT4KICAgIDxtai1zZWN0aW9uIGJhY2tncm91bmQtdXJsPSJodHRwczovL2NhLXRpbWVzLmJyaWdodHNwb3RjZG4uY29tL2RpbXM0L2RlZmF1bHQvMmFmMTY1Yy8yMTQ3NDgzNjQ3L3N0cmlwL3RydWUvY3JvcC8yMDQ4eDEzNjMrMCswL3Jlc2l6ZS8xNDQweDk1OCEvcXVhbGl0eS85MC8/dXJsPWh0dHBzJTNBJTJGJTJGd3d3LnRyYmltZy5jb20lMkZpbWctNGY1NjFkMzclMkZ0dXJiaW5lJTJGb3JsLWRpc25leWZhbnRhc3k3MjAxMjAzMDYwNjIwNTUiCiAgICAgICAgYmFja2dyb3VuZC1zaXplPSJjb3ZlciIKICAgICAgICBiYWNrZ3JvdW5kLXJlcGVhdD0ibm8tcmVwZWF0Ij4KICAgICAgICA8bWotY29sdW1uIHdpZHRoPSI2MDBweCI+CiAgICAgICAgICAgIDxtai10ZXh0ICBhbGlnbj0iY2VudGVyIgogICAgICAgICAgICAgICAgY29sb3I9IiNmZmYiCiAgICAgICAgICAgICAgICBmb250LXNpemU9IjQwcHgiCiAgICAgICAgICAgICAgICBmb250LWZhbWlseT0iSGVsdmV0aWNhIE5ldWUiPnt7cHJvbW90aW9uLm5hbWV9fTwvbWotdGV4dD4KICAgICAgICAgICAgPG1qLWJ1dHRvbiBiYWNrZ3JvdW5kLWNvbG9yPSIjRjYzQTREIiBocmVmPSIjIj4KICAgICAgICAgICAgICAgIFNlZSBQcm9tb3Rpb25zCiAgICAgICAgICAgIDwvbWotYnV0dG9uPgogICAgICAgIDwvbWotY29sdW1uPgogICAgPC9tai1zZWN0aW9uPgogICAgPCEtLSBFbWFpbCBJbnRyb2R1Y3Rpb24gLS0+CiAgICA8bWotc2VjdGlvbiBiYWNrZ3JvdW5kLWNvbG9yPSIjZmFmYWZhIj4KICAgICAgICA8bWotY29sdW1uIHdpZHRoPSI0MDBweCI+CiAgICAgICAgICA8bWotdGV4dCBmb250LXN0eWxlPSJib2xkIgogICAgICAgICAgICBmb250LXNpemU9IjIwcHgiCiAgICAgICAgICAgIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EgTmV1ZSIKICAgICAgICAgICAgY29sb3I9IiM2MjYyNjIiPlVsdGltYXRlIENocmlzdG1hcyBFeHBlcmllbmNlPC9tai10ZXh0PgogICAgICAgICAgICA8bWotdGV4dCBjb2xvcj0iIzUyNTI1MiI+CiAgICAgICAgICAgICAgICBMb3JlbSBpcHN1bSBkb2xvciBzaXQgYW1ldCwgY29uc2VjdGV0dXIgYWRpcGlzY2luZyBlbGl0LiBQcm9pbiBydXRydW0gZW5pbSBlZ2V0IG1hZ25hIGVmZmljaXR1ciwgZXUgc2VtcGVyIGF1Z3VlIHNlbXBlci4gQWxpcXVhbSBlcmF0IHZvbHV0cGF0LiBDcmFzIGlkIGR1aSBsZWN0dXMuIFZlc3RpYnVsdW0gc2VkIGZpbmlidXMgbGVjdHVzLCBzaXQgYW1ldCBzdXNjaXBpdCBuaWJoLiBQcm9pbiBuZWMgY29tbW9kbyBwdXJ1cy4gU2VkIGVnZXQgbnVsbGEgZWxpdC4gTnVsbGEgYWxpcXVldCBtb2xsaXMgZmF1Y2lidXMuCiAgICAgICAgICAgIDwvbWotdGV4dD4KICAgICAgICAgICAgPG1qLWJ1dHRvbiBiYWNrZ3JvdW5kLWNvbG9yPSIjRjQ1RTQzIiBocmVmPSIjIj5MZWFybiBtb3JlPC9tai1idXR0b24+CiAgICAgICAgPC9tai1jb2x1bW4+CiAgICA8L21qLXNlY3Rpb24+CiAgICA8IS0tIENvbHVtbnMgc2VjdGlvbiAtLT4KICAgIDxtai1zZWN0aW9uIGJhY2tncm91bmQtY29sb3I9IndoaXRlIj4KICAgICAgICA8IS0tIExlZnQgaW1hZ2UgLS0+CiAgICAgICAgPG1qLWNvbHVtbj4KICAgICAgICAgICAgPG1qLWltYWdlIHdpZHRoPSIyMDBweCIKICAgICAgICAgICAgICAgIHNyYz0iaHR0cHM6Ly9uYXZpcy1jb25zdWx0aW5nLmNvbS93cC1jb250ZW50L3VwbG9hZHMvMjAxOS8wOS9DcnVpc2UxLTEucG5nIi8+CiAgICAgICAgPC9tai1jb2x1bW4+CiAgICAgICAgPCEtLSByaWdodCBwYXJhZ3JhcGggLS0+CiAgICAgICAgPG1qLWNvbHVtbj4KICAgICAgICAgICAgPG1qLXRleHQgZm9udC1zdHlsZT0iYm9sZCIKICAgICAgICAgICAgICAgIGZvbnQtc2l6ZT0iMjBweCIKICAgICAgICAgICAgICAgIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EgTmV1ZSIKICAgICAgICAgICAgICAgIGNvbG9yPSIjNjI2MjYyIj4KICAgICAgICAgICAgICAgIEFtYXppbmcgRXhwZXJpZW5jZXMKICAgICAgICAgICAgPC9tai10ZXh0PgogICAgICAgICAgICA8bWotdGV4dCBjb2xvcj0iIzUyNTI1MiI+CiAgICAgICAgICAgICAgICBMb3JlbSBpcHN1bSBkb2xvciBzaXQgYW1ldCwgY29uc2VjdGV0dXIgYWRpcGlzY2luZyBlbGl0LgogICAgICAgICAgICAgICAgUHJvaW4gcnV0cnVtIGVuaW0gZWdldCBtYWduYSBlZmZpY2l0dXIsIGV1IHNlbXBlciBhdWd1ZSBzZW1wZXIuCiAgICAgICAgICAgICAgICBBbGlxdWFtIGVyYXQgdm9sdXRwYXQuIENyYXMgaWQgZHVpIGxlY3R1cy4gVmVzdGlidWx1bSBzZWQgZmluaWJ1cwogICAgICAgICAgICAgICAgbGVjdHVzLgogICAgICAgICAgICA8L21qLXRleHQ+CiAgICAgICAgPC9tai1jb2x1bW4+CiAgICA8L21qLXNlY3Rpb24+CiAgICA8IS0tIEljb25zIC0tPgogICAgPG1qLXNlY3Rpb24gYmFja2dyb3VuZC1jb2xvcj0iI2ZiZmJmYiI+CiAgICAgICAgPG1qLWNvbHVtbj4KICAgICAgICAgICAgPG1qLWltYWdlIHdpZHRoPSIxMDBweCIgc3JjPSJodHRwczovLzE5MW4ubWouYW0vaW1nLzE5MW4vM3MveDBsLnBuZyIgLz4KICAgICAgICA8L21qLWNvbHVtbj4KICAgICAgICA8bWotY29sdW1uPgogICAgICAgICAgICA8bWotaW1hZ2Ugd2lkdGg9IjEwMHB4IiBzcmM9Imh0dHBzOi8vMTkxbi5tai5hbS9pbWcvMTkxbi8zcy94MDEucG5nIiAvPgogICAgICAgIDwvbWotY29sdW1uPgogICAgICAgIDxtai1jb2x1bW4+CiAgICAgICAgICAgIDxtai1pbWFnZSB3aWR0aD0iMTAwcHgiIHNyYz0iaHR0cHM6Ly8xOTFuLm1qLmFtL2ltZy8xOTFuLzNzL3gwcy5wbmciIC8+CiAgICAgICAgPC9tai1jb2x1bW4+CiAgICA8L21qLXNlY3Rpb24+CiAgICA8IS0tIFNvY2lhbCBpY29ucyAtLT4KICAgIDxtai1zZWN0aW9uIGJhY2tncm91bmQtY29sb3I9IiNlN2U3ZTciPgogICAgICAgIDxtai1jb2x1bW4+CiAgICAgICAgICAgIDxtai1zb2NpYWw+CiAgICAgICAgICAgICAgICA8bWotc29jaWFsLWVsZW1lbnQgbmFtZT0iaW5zdGFncmFtIiAvPgogICAgICAgICAgICA8L21qLXNvY2lhbD4KICAgICAgICA8L21qLWNvbHVtbj4KICAgIDwvbWotc2VjdGlvbj4KICA8L21qLWJvZHk+CjwvbWptbD4="
            )
        )
        val expectedResult = mutableListOf(
            KTemplate(
                templateId = "1",
                templateName = "Cruises",
                templateType = TemplateType.CONTROL,
                templateLanguage = TemplateLanguage.EN,
                templateContent = "\uD83D\uDC4B Jane,\n\n<!--if sendingUser is exists in the context-->\n    Doe welcomes you.\n\n<!--if sendingUser is doesn't exist in the context-->\n"
            ),
            KTemplate(
                templateId = "2",
                templateName = "Cruises",
                templateType = TemplateType.CONTROL,
                templateLanguage = TemplateLanguage.EN,
                templateContent = "\n    <!doctype html>\n    <html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:v=\"urn:schemas-microsoft-com:vml\" xmlns:o=\"urn:schemas-microsoft-com:office:office\">\n      <head>\n        <title>\n          \n        </title>\n        <!--[if !mso]><!-- -->\n        <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\">\n        <!--<![endif]-->\n        <meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\">\n        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n        <style type=\"text/css\">\n          #outlook a { padding:0; }\n          body { margin:0;padding:0;-webkit-text-size-adjust:100%;-ms-text-size-adjust:100%; }\n          table, td { border-collapse:collapse;mso-table-lspace:0pt;mso-table-rspace:0pt; }\n          img { border:0;height:auto;line-height:100%; outline:none;text-decoration:none;-ms-interpolation-mode:bicubic; }\n          p { display:block;margin:13px 0; }\n        </style>\n        <!--[if mso]>\n        <xml>\n        <o:OfficeDocumentSettings>\n          <o:AllowPNG/>\n          <o:PixelsPerInch>96</o:PixelsPerInch>\n        </o:OfficeDocumentSettings>\n        </xml>\n        <![endif]-->\n        <!--[if lte mso 11]>\n        <style type=\"text/css\">\n          .mj-outlook-group-fix { width:100% !important; }\n        </style>\n        <![endif]-->\n        \n      <!--[if !mso]><!-->\n        <link href=\"https://fonts.googleapis.com/css?family=Ubuntu:300,400,500,700\" rel=\"stylesheet\" type=\"text/css\">\n        <style type=\"text/css\">\n          @import url(https://fonts.googleapis.com/css?family=Ubuntu:300,400,500,700);\n        </style>\n      <!--<![endif]-->\n\n    \n        \n    <style type=\"text/css\">\n      @media only screen and (min-width:480px) {\n        .mj-column-per-100 { width:100% !important; max-width: 100%; }\n.mj-column-px-600 { width:600px !important; max-width: 600px; }\n.mj-column-px-400 { width:400px !important; max-width: 400px; }\n.mj-column-per-50 { width:50% !important; max-width: 50%; }\n.mj-column-per-33-333333333333336 { width:33.333333333333336% !important; max-width: 33.333333333333336%; }\n      }\n    </style>\n    \n  \n        <style type=\"text/css\">\n        \n        \n\n    @media only screen and (max-width:480px) {\n      table.mj-full-width-mobile { width: 100% !important; }\n      td.mj-full-width-mobile { width: auto !important; }\n    }\n  \n        </style>\n        \n        \n      </head>\n      <body>\n        \n        \n      <div\n         style=\"\"\n      >\n        <!-- Company Header -->\n      \n      <!--[if mso | IE]>\n      <table\n         align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" class=\"\" style=\"width:600px;\" width=\"600\"\n      >\n        <tr>\n          <td style=\"line-height:0px;font-size:0px;mso-line-height-rule:exactly;\">\n      <![endif]-->\n    \n      \n      <div  style=\"background:#f0f0f0;background-color:#f0f0f0;margin:0px auto;max-width:600px;\">\n        \n        <table\n           align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"background:#f0f0f0;background-color:#f0f0f0;width:100%;\"\n        >\n          <tbody>\n            <tr>\n              <td\n                 style=\"direction:ltr;font-size:0px;padding:20px 0;text-align:center;\"\n              >\n                <!--[if mso | IE]>\n                  <table role=\"presentation\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n                \n        <tr>\n      \n            <td\n               class=\"\" style=\"vertical-align:top;width:600px;\"\n            >\n          <![endif]-->\n            \n      <div\n         class=\"mj-column-per-100 mj-outlook-group-fix\" style=\"font-size:0px;text-align:left;direction:ltr;display:inline-block;vertical-align:top;width:100%;\"\n      >\n        \n      <table\n         border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"vertical-align:top;\" width=\"100%\"\n      >\n        \n            <tr>\n              <td\n                 align=\"center\" style=\"font-size:0px;padding:10px 25px;word-break:break-word;\"\n              >\n                \n      <div\n         style=\"font-family:Ubuntu, Helvetica, Arial, sans-serif;font-size:20px;font-style:bold;line-height:1;text-align:center;color:#626262;\"\n      >Central Park Cruises</div>\n    \n              </td>\n            </tr>\n          \n      </table>\n    \n      </div>\n    \n          <!--[if mso | IE]>\n            </td>\n          \n        </tr>\n      \n                  </table>\n                <![endif]-->\n              </td>\n            </tr>\n          </tbody>\n        </table>\n        \n      </div>\n    \n      \n      <!--[if mso | IE]>\n          </td>\n        </tr>\n      </table>\n      <![endif]-->\n    \n    <!-- Image Header -->\n      \n      <!--[if mso | IE]>\n      <table\n         align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" class=\"\" style=\"width:600px;\" width=\"600\"\n      >\n        <tr>\n          <td style=\"line-height:0px;font-size:0px;mso-line-height-rule:exactly;\">\n      \n        <v:rect  style=\"width:600px;\" xmlns:v=\"urn:schemas-microsoft-com:vml\" fill=\"true\" stroke=\"false\">\n        <v:fill  origin=\"0.5, 0\" position=\"0.5, 0\" src=\"https://ca-times.brightspotcdn.com/dims4/default/2af165c/2147483647/strip/true/crop/2048x1363+0+0/resize/1440x958!/quality/90/?url=https%3A%2F%2Fwww.trbimg.com%2Fimg-4f561d37%2Fturbine%2Forl-disneyfantasy720120306062055\" type=\"tile\" />\n        <v:textbox style=\"mso-fit-shape-to-text:true\" inset=\"0,0,0,0\">\n      <![endif]-->\n          \n      <div  style=\"background:url(https://ca-times.brightspotcdn.com/dims4/default/2af165c/2147483647/strip/true/crop/2048x1363+0+0/resize/1440x958!/quality/90/?url=https%3A%2F%2Fwww.trbimg.com%2Fimg-4f561d37%2Fturbine%2Forl-disneyfantasy720120306062055) top center / cover no-repeat;margin:0px auto;max-width:600px;\">\n        <div  style=\"line-height:0;font-size:0;\">\n        <table\n           align=\"center\" background=\"https://ca-times.brightspotcdn.com/dims4/default/2af165c/2147483647/strip/true/crop/2048x1363+0+0/resize/1440x958!/quality/90/?url=https%3A%2F%2Fwww.trbimg.com%2Fimg-4f561d37%2Fturbine%2Forl-disneyfantasy720120306062055\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"background:url(https://ca-times.brightspotcdn.com/dims4/default/2af165c/2147483647/strip/true/crop/2048x1363+0+0/resize/1440x958!/quality/90/?url=https%3A%2F%2Fwww.trbimg.com%2Fimg-4f561d37%2Fturbine%2Forl-disneyfantasy720120306062055) top center / cover no-repeat;width:100%;\"\n        >\n          <tbody>\n            <tr>\n              <td\n                 style=\"direction:ltr;font-size:0px;padding:20px 0;text-align:center;\"\n              >\n                <!--[if mso | IE]>\n                  <table role=\"presentation\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n                \n        <tr>\n      \n            <td\n               class=\"\" style=\"vertical-align:top;width:600px;\"\n            >\n          <![endif]-->\n            \n      <div\n         class=\"mj-column-px-600 mj-outlook-group-fix\" style=\"font-size:0px;text-align:left;direction:ltr;display:inline-block;vertical-align:top;width:100%;\"\n      >\n        \n      <table\n         border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"vertical-align:top;\" width=\"100%\"\n      >\n        \n            <tr>\n              <td\n                 align=\"center\" style=\"font-size:0px;padding:10px 25px;word-break:break-word;\"\n              >\n                \n      <div\n         style=\"font-family:Helvetica Neue;font-size:40px;line-height:1;text-align:center;color:#ffffff;\"\n      >New Year Promotion</div>\n    \n              </td>\n            </tr>\n          \n            <tr>\n              <td\n                 align=\"center\" vertical-align=\"middle\" style=\"font-size:0px;padding:10px 25px;word-break:break-word;\"\n              >\n                \n      <table\n         border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"border-collapse:separate;line-height:100%;\"\n      >\n        <tr>\n          <td\n             align=\"center\" bgcolor=\"#F63A4D\" role=\"presentation\" style=\"border:none;border-radius:3px;cursor:auto;mso-padding-alt:10px 25px;background:#F63A4D;\" valign=\"middle\"\n          >\n            <a\n               href=\"#\" style=\"display:inline-block;background:#F63A4D;color:#ffffff;font-family:Ubuntu, Helvetica, Arial, sans-serif;font-size:13px;font-weight:normal;line-height:120%;margin:0;text-decoration:none;text-transform:none;padding:10px 25px;mso-padding-alt:0px;border-radius:3px;\" target=\"_blank\"\n            >\n              See Promotions\n            </a>\n          </td>\n        </tr>\n      </table>\n    \n              </td>\n            </tr>\n          \n      </table>\n    \n      </div>\n    \n          <!--[if mso | IE]>\n            </td>\n          \n        </tr>\n      \n                  </table>\n                <![endif]-->\n              </td>\n            </tr>\n          </tbody>\n        </table>\n        </div>\n      </div>\n    \n        <!--[if mso | IE]>\n        </v:textbox>\n      </v:rect>\n    \n          </td>\n        </tr>\n      </table>\n      <![endif]-->\n    \n    <!-- Email Introduction -->\n      \n      <!--[if mso | IE]>\n      <table\n         align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" class=\"\" style=\"width:600px;\" width=\"600\"\n      >\n        <tr>\n          <td style=\"line-height:0px;font-size:0px;mso-line-height-rule:exactly;\">\n      <![endif]-->\n    \n      \n      <div  style=\"background:#fafafa;background-color:#fafafa;margin:0px auto;max-width:600px;\">\n        \n        <table\n           align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"background:#fafafa;background-color:#fafafa;width:100%;\"\n        >\n          <tbody>\n            <tr>\n              <td\n                 style=\"direction:ltr;font-size:0px;padding:20px 0;text-align:center;\"\n              >\n                <!--[if mso | IE]>\n                  <table role=\"presentation\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n                \n        <tr>\n      \n            <td\n               class=\"\" style=\"vertical-align:top;width:400px;\"\n            >\n          <![endif]-->\n            \n      <div\n         class=\"mj-column-px-400 mj-outlook-group-fix\" style=\"font-size:0px;text-align:left;direction:ltr;display:inline-block;vertical-align:top;width:100%;\"\n      >\n        \n      <table\n         border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"vertical-align:top;\" width=\"100%\"\n      >\n        \n            <tr>\n              <td\n                 align=\"left\" style=\"font-size:0px;padding:10px 25px;word-break:break-word;\"\n              >\n                \n      <div\n         style=\"font-family:Helvetica Neue;font-size:20px;font-style:bold;line-height:1;text-align:left;color:#626262;\"\n      >Ultimate Christmas Experience</div>\n    \n              </td>\n            </tr>\n          \n            <tr>\n              <td\n                 align=\"left\" style=\"font-size:0px;padding:10px 25px;word-break:break-word;\"\n              >\n                \n      <div\n         style=\"font-family:Ubuntu, Helvetica, Arial, sans-serif;font-size:13px;line-height:1;text-align:left;color:#525252;\"\n      >Lorem ipsum dolor sit amet, consectetur adipiscing elit. Proin rutrum enim eget magna efficitur, eu semper augue semper. Aliquam erat volutpat. Cras id dui lectus. Vestibulum sed finibus lectus, sit amet suscipit nibh. Proin nec commodo purus. Sed eget nulla elit. Nulla aliquet mollis faucibus.</div>\n    \n              </td>\n            </tr>\n          \n            <tr>\n              <td\n                 align=\"center\" vertical-align=\"middle\" style=\"font-size:0px;padding:10px 25px;word-break:break-word;\"\n              >\n                \n      <table\n         border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"border-collapse:separate;line-height:100%;\"\n      >\n        <tr>\n          <td\n             align=\"center\" bgcolor=\"#F45E43\" role=\"presentation\" style=\"border:none;border-radius:3px;cursor:auto;mso-padding-alt:10px 25px;background:#F45E43;\" valign=\"middle\"\n          >\n            <a\n               href=\"#\" style=\"display:inline-block;background:#F45E43;color:#ffffff;font-family:Ubuntu, Helvetica, Arial, sans-serif;font-size:13px;font-weight:normal;line-height:120%;margin:0;text-decoration:none;text-transform:none;padding:10px 25px;mso-padding-alt:0px;border-radius:3px;\" target=\"_blank\"\n            >\n              Learn more\n            </a>\n          </td>\n        </tr>\n      </table>\n    \n              </td>\n            </tr>\n          \n      </table>\n    \n      </div>\n    \n          <!--[if mso | IE]>\n            </td>\n          \n        </tr>\n      \n                  </table>\n                <![endif]-->\n              </td>\n            </tr>\n          </tbody>\n        </table>\n        \n      </div>\n    \n      \n      <!--[if mso | IE]>\n          </td>\n        </tr>\n      </table>\n      <![endif]-->\n    \n    <!-- Columns section -->\n      \n      <!--[if mso | IE]>\n      <table\n         align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" class=\"\" style=\"width:600px;\" width=\"600\"\n      >\n        <tr>\n          <td style=\"line-height:0px;font-size:0px;mso-line-height-rule:exactly;\">\n      <![endif]-->\n    \n      \n      <div  style=\"background:white;background-color:white;margin:0px auto;max-width:600px;\">\n        \n        <table\n           align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"background:white;background-color:white;width:100%;\"\n        >\n          <tbody>\n            <tr>\n              <td\n                 style=\"direction:ltr;font-size:0px;padding:20px 0;text-align:center;\"\n              >\n                <!--[if mso | IE]>\n                  <table role=\"presentation\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n                \n        <tr>\n      <![endif]-->\n      <!-- Left image -->\n          <!--[if mso | IE]>\n            <td\n               class=\"\" style=\"vertical-align:top;width:300px;\"\n            >\n          <![endif]-->\n            \n      <div\n         class=\"mj-column-per-50 mj-outlook-group-fix\" style=\"font-size:0px;text-align:left;direction:ltr;display:inline-block;vertical-align:top;width:100%;\"\n      >\n        \n      <table\n         border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"vertical-align:top;\" width=\"100%\"\n      >\n        \n            <tr>\n              <td\n                 align=\"center\" style=\"font-size:0px;padding:10px 25px;word-break:break-word;\"\n              >\n                \n      <table\n         border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"border-collapse:collapse;border-spacing:0px;\"\n      >\n        <tbody>\n          <tr>\n            <td  style=\"width:200px;\">\n              \n      <img\n         height=\"auto\" src=\"https://navis-consulting.com/wp-content/uploads/2019/09/Cruise1-1.png\" style=\"border:0;display:block;outline:none;text-decoration:none;height:auto;width:100%;font-size:13px;\" width=\"200\"\n      />\n    \n            </td>\n          </tr>\n        </tbody>\n      </table>\n    \n              </td>\n            </tr>\n          \n      </table>\n    \n      </div>\n    \n          <!--[if mso | IE]>\n            </td>\n          <![endif]-->\n    <!-- right paragraph -->\n          <!--[if mso | IE]>\n            <td\n               class=\"\" style=\"vertical-align:top;width:300px;\"\n            >\n          <![endif]-->\n            \n      <div\n         class=\"mj-column-per-50 mj-outlook-group-fix\" style=\"font-size:0px;text-align:left;direction:ltr;display:inline-block;vertical-align:top;width:100%;\"\n      >\n        \n      <table\n         border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"vertical-align:top;\" width=\"100%\"\n      >\n        \n            <tr>\n              <td\n                 align=\"left\" style=\"font-size:0px;padding:10px 25px;word-break:break-word;\"\n              >\n                \n      <div\n         style=\"font-family:Helvetica Neue;font-size:20px;font-style:bold;line-height:1;text-align:left;color:#626262;\"\n      >Amazing Experiences</div>\n    \n              </td>\n            </tr>\n          \n            <tr>\n              <td\n                 align=\"left\" style=\"font-size:0px;padding:10px 25px;word-break:break-word;\"\n              >\n                \n      <div\n         style=\"font-family:Ubuntu, Helvetica, Arial, sans-serif;font-size:13px;line-height:1;text-align:left;color:#525252;\"\n      >Lorem ipsum dolor sit amet, consectetur adipiscing elit.\n                Proin rutrum enim eget magna efficitur, eu semper augue semper.\n                Aliquam erat volutpat. Cras id dui lectus. Vestibulum sed finibus\n                lectus.</div>\n    \n              </td>\n            </tr>\n          \n      </table>\n    \n      </div>\n    \n          <!--[if mso | IE]>\n            </td>\n          \n        </tr>\n      \n                  </table>\n                <![endif]-->\n              </td>\n            </tr>\n          </tbody>\n        </table>\n        \n      </div>\n    \n      \n      <!--[if mso | IE]>\n          </td>\n        </tr>\n      </table>\n      <![endif]-->\n    \n    <!-- Icons -->\n      \n      <!--[if mso | IE]>\n      <table\n         align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" class=\"\" style=\"width:600px;\" width=\"600\"\n      >\n        <tr>\n          <td style=\"line-height:0px;font-size:0px;mso-line-height-rule:exactly;\">\n      <![endif]-->\n    \n      \n      <div  style=\"background:#fbfbfb;background-color:#fbfbfb;margin:0px auto;max-width:600px;\">\n        \n        <table\n           align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"background:#fbfbfb;background-color:#fbfbfb;width:100%;\"\n        >\n          <tbody>\n            <tr>\n              <td\n                 style=\"direction:ltr;font-size:0px;padding:20px 0;text-align:center;\"\n              >\n                <!--[if mso | IE]>\n                  <table role=\"presentation\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n                \n        <tr>\n      \n            <td\n               class=\"\" style=\"vertical-align:top;width:200px;\"\n            >\n          <![endif]-->\n            \n      <div\n         class=\"mj-column-per-33-333333333333336 mj-outlook-group-fix\" style=\"font-size:0px;text-align:left;direction:ltr;display:inline-block;vertical-align:top;width:100%;\"\n      >\n        \n      <table\n         border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"vertical-align:top;\" width=\"100%\"\n      >\n        \n            <tr>\n              <td\n                 align=\"center\" style=\"font-size:0px;padding:10px 25px;word-break:break-word;\"\n              >\n                \n      <table\n         border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"border-collapse:collapse;border-spacing:0px;\"\n      >\n        <tbody>\n          <tr>\n            <td  style=\"width:100px;\">\n              \n      <img\n         height=\"auto\" src=\"https://191n.mj.am/img/191n/3s/x0l.png\" style=\"border:0;display:block;outline:none;text-decoration:none;height:auto;width:100%;font-size:13px;\" width=\"100\"\n      />\n    \n            </td>\n          </tr>\n        </tbody>\n      </table>\n    \n              </td>\n            </tr>\n          \n      </table>\n    \n      </div>\n    \n          <!--[if mso | IE]>\n            </td>\n          \n            <td\n               class=\"\" style=\"vertical-align:top;width:200px;\"\n            >\n          <![endif]-->\n            \n      <div\n         class=\"mj-column-per-33-333333333333336 mj-outlook-group-fix\" style=\"font-size:0px;text-align:left;direction:ltr;display:inline-block;vertical-align:top;width:100%;\"\n      >\n        \n      <table\n         border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"vertical-align:top;\" width=\"100%\"\n      >\n        \n            <tr>\n              <td\n                 align=\"center\" style=\"font-size:0px;padding:10px 25px;word-break:break-word;\"\n              >\n                \n      <table\n         border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"border-collapse:collapse;border-spacing:0px;\"\n      >\n        <tbody>\n          <tr>\n            <td  style=\"width:100px;\">\n              \n      <img\n         height=\"auto\" src=\"https://191n.mj.am/img/191n/3s/x01.png\" style=\"border:0;display:block;outline:none;text-decoration:none;height:auto;width:100%;font-size:13px;\" width=\"100\"\n      />\n    \n            </td>\n          </tr>\n        </tbody>\n      </table>\n    \n              </td>\n            </tr>\n          \n      </table>\n    \n      </div>\n    \n          <!--[if mso | IE]>\n            </td>\n          \n            <td\n               class=\"\" style=\"vertical-align:top;width:200px;\"\n            >\n          <![endif]-->\n            \n      <div\n         class=\"mj-column-per-33-333333333333336 mj-outlook-group-fix\" style=\"font-size:0px;text-align:left;direction:ltr;display:inline-block;vertical-align:top;width:100%;\"\n      >\n        \n      <table\n         border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"vertical-align:top;\" width=\"100%\"\n      >\n        \n            <tr>\n              <td\n                 align=\"center\" style=\"font-size:0px;padding:10px 25px;word-break:break-word;\"\n              >\n                \n      <table\n         border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"border-collapse:collapse;border-spacing:0px;\"\n      >\n        <tbody>\n          <tr>\n            <td  style=\"width:100px;\">\n              \n      <img\n         height=\"auto\" src=\"https://191n.mj.am/img/191n/3s/x0s.png\" style=\"border:0;display:block;outline:none;text-decoration:none;height:auto;width:100%;font-size:13px;\" width=\"100\"\n      />\n    \n            </td>\n          </tr>\n        </tbody>\n      </table>\n    \n              </td>\n            </tr>\n          \n      </table>\n    \n      </div>\n    \n          <!--[if mso | IE]>\n            </td>\n          \n        </tr>\n      \n                  </table>\n                <![endif]-->\n              </td>\n            </tr>\n          </tbody>\n        </table>\n        \n      </div>\n    \n      \n      <!--[if mso | IE]>\n          </td>\n        </tr>\n      </table>\n      <![endif]-->\n    \n    <!-- Social icons -->\n      \n      <!--[if mso | IE]>\n      <table\n         align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" class=\"\" style=\"width:600px;\" width=\"600\"\n      >\n        <tr>\n          <td style=\"line-height:0px;font-size:0px;mso-line-height-rule:exactly;\">\n      <![endif]-->\n    \n      \n      <div  style=\"background:#e7e7e7;background-color:#e7e7e7;margin:0px auto;max-width:600px;\">\n        \n        <table\n           align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"background:#e7e7e7;background-color:#e7e7e7;width:100%;\"\n        >\n          <tbody>\n            <tr>\n              <td\n                 style=\"direction:ltr;font-size:0px;padding:20px 0;text-align:center;\"\n              >\n                <!--[if mso | IE]>\n                  <table role=\"presentation\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n                \n        <tr>\n      \n            <td\n               class=\"\" style=\"vertical-align:top;width:600px;\"\n            >\n          <![endif]-->\n            \n      <div\n         class=\"mj-column-per-100 mj-outlook-group-fix\" style=\"font-size:0px;text-align:left;direction:ltr;display:inline-block;vertical-align:top;width:100%;\"\n      >\n        \n      <table\n         border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"vertical-align:top;\" width=\"100%\"\n      >\n        \n            <tr>\n              <td\n                 align=\"center\" style=\"font-size:0px;padding:10px 25px;word-break:break-word;\"\n              >\n                \n      \n     <!--[if mso | IE]>\n      <table\n         align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\"\n      >\n        <tr>\n      \n              <td>\n            <![endif]-->\n              <table\n                 align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"float:none;display:inline-table;\"\n              >\n                \n      <tr\n        \n      >\n        <td  style=\"padding:4px;\">\n          <table\n             border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"background:#3f729b;border-radius:3px;width:20px;\"\n          >\n            <tr>\n              <td  style=\"font-size:0;height:20px;vertical-align:middle;width:20px;\">\n                \n                    <img\n                       height=\"20\" src=\"https://www.mailjet.com/images/theme/v1/icons/ico-social/instagram.png\" style=\"border-radius:3px;display:block;\" width=\"20\"\n                    />\n                  \n                </td>\n              </tr>\n          </table>\n        </td>\n        \n      </tr>\n    \n              </table>\n            <!--[if mso | IE]>\n              </td>\n            \n          </tr>\n        </table>\n      <![endif]-->\n    \n    \n              </td>\n            </tr>\n          \n      </table>\n    \n      </div>\n    \n          <!--[if mso | IE]>\n            </td>\n          \n        </tr>\n      \n                  </table>\n                <![endif]-->\n              </td>\n            </tr>\n          </tbody>\n        </table>\n        \n      </div>\n    \n      \n      <!--[if mso | IE]>\n          </td>\n        </tr>\n      </table>\n      <![endif]-->\n    \n    \n      </div>\n    \n      </body>\n    </html>\n  "
            )
        )

        //given
        given(templateRepository.findById(anyString()))
            .willAnswer {
                val argument = it.arguments[0]
                when(argument){
                    "1" -> Optional.of(mockData[0])
                    "2" -> Optional.of(mockData[1])
                    else -> Optional.empty()
                }

            }

        //when
        val actualResult = webTestClient.post()
            .uri("$baseUrl/personalize")
            .bodyValue(givenInput)
            .header("Content-Type", MediaType.APPLICATION_JSON_VALUE)
            .exchange()
            .expectStatus().isOk
            .expectBodyList(KTemplate::class.java)
            .returnResult()
            .responseBody

        //then
        expectedResult.forEach {expected ->
            actualResult?.first { it.templateId == expected.templateId }?.templateContent?.isNotBlank()?.let { assert(it) }
        }

    }
}